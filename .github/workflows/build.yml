name: Debug Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y clang-14 lld-14 llvm-14 bc build-essential git flex bison libssl-dev libncurses-dev

      - name: Clone kernel source
        run: |
          git clone --depth=1 https://github.com/usama19931993/exynos990-kernel1.git kernel

      - name: Clone KernelSU
        run: |
          git clone --depth=1 https://github.com/tiann/KernelSU.git kernel/kernelSU
          mkdir -p kernel/drivers/kernelsu
          cp -a kernel/kernelSU/kernel/. kernel/drivers/kernelsu/
          echo 'obj-y += kernelsu/' >> kernel/drivers/Makefile
          echo 'source "drivers/kernelsu/Kconfig"' >> kernel/drivers/Kconfig

      - name: Build kernel
        run: |
          cd kernel
          make O=out ARCH=arm64 extreme_z3s_defconfig
          make O=out ARCH=arm64 olddefconfig
          make -j$(nproc) O=out ARCH=arm64 \
            CC=clang-14 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LD=ld.lld-14 \
            LLVM=1 LLVM_IAS=1 \
            KCFLAGS="-Wno-error -march=armv8.2-a" || (echo "‚ùå Failed build" && exit 1)

      - name: List boot outputs
        run: |
          echo "üîç Checking out/arch/arm64/boot/"
          find kernel/out/arch/arm64/boot -type f