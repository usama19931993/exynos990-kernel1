name: Build Kernel for SM-G988B (Exynos990)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dummy repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential curl flex git libncurses-dev libssl-dev python3 unzip wget xz-utils

      - name: Clone kernel source into kernel/ folder
        run: git clone --depth=1 https://github.com/usama19931993/exynos990-kernel1.git kernel

      - name: Clone KernelSU
        run: |
          cd kernel
          git clone --depth=1 https://github.com/tiann/KernelSU.git
          mv KernelSU/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig

      - name: Enable KernelSU in defconfig
        run: echo 'CONFIG_KSU=y' >> kernel/arch/arm64/configs/g988_defconfig

      - name: Build kernel
        run: |
          cd kernel
          export CROSS_COMPILE=aarch64-linux-gnu-
          export PATH="$HOME/toolchains/gcc/bin:$PATH"
          mkdir -p out
          make O=out ARCH=arm64 g988_defconfig
          make -j$(nproc) O=out ARCH=arm64

      - name: Package boot image for Odin
        run: |
          cd kernel
          mkdir -p dist
          cp out/arch/arm64/boot/Image dist/
          cp out/arch/arm64/boot/dts/exynos/*.dtb dist/
          cat dist/Image dist/*.dtb > dist/boot.img
          tar -H ustar -c dist/boot.img > dist/boot.tar
          mv dist/boot.tar dist/boot.tar.md5

      - name: Upload boot.tar.md5
        uses: actions/upload-artifact@v3
        with:
          name: boot.tar.md5
          path: kernel/dist/boot.tar.md5
