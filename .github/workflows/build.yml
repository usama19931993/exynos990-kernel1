name: Manual Kernel Build Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: سحب ملفات المشروع
      uses: actions/checkout@v4

    - name: تثبيت أدوات البناء
      run: |
        sudo apt update
        sudo apt install -y clang-14 lld-14 bc bison build-essential curl flex git libncurses-dev libssl-dev python3 unzip wget xz-utils

    - name: تنظيف وبناء النواة
      run: |
        echo "🧹 تنظيف مجلد out/"
        rm -rf kernel/out
        mkdir -p kernel/out

        echo "🔨 بدء بناء الكيرنل..."
        cd kernel
        make -j$(nproc) O=out ARCH=arm64 \
          CC=clang-14 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-gnu- \
          LD=ld.lld-14 \
          LLVM=1 \
          LLVM_IAS=1 \
          KCFLAGS="-Wno-error -march=armv8.2-a" \
          2>&1 | tee out/build.log || {
            echo "❌ فشل البناء، آخر 200 سطر:"
            tail -n 200 out/build.log
            exit 1
          }