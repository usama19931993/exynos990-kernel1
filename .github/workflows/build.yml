name: Manual Kernel Build Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Ø³Ø­Ø¨ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      uses: actions/checkout@v4

    - name: ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
      run: |
        sudo apt update
        sudo apt install -y clang-14 lld-14 bc bison build-essential curl flex git libncurses-dev libssl-dev python3 unzip wget xz-utils

    - name: ØªÙ†Ø¸ÙŠÙ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆØ§Ø©
      run: |
        echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù…Ø¬Ù„Ø¯ out/"
        rm -rf kernel/out
        mkdir -p kernel/out

        echo "ğŸ”¨ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙŠØ±Ù†Ù„..."
        cd kernel
        make -j$(nproc) O=out ARCH=arm64 \
          CC=clang-14 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-gnu- \
          LD=ld.lld-14 \
          LLVM=1 \
          LLVM_IAS=1 \
          KCFLAGS="-Wno-error -march=armv8.2-a" \
          2>&1 | tee out/build.log || {
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ØŒ Ø¢Ø®Ø± 200 Ø³Ø·Ø±:"
            tail -n 200 out/build.log
            exit 1
          }