name: Build Kernel for SM-G988B (Exynos990)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dummy repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential curl flex git libncurses-dev libssl-dev python3 unzip wget xz-utils

      - name: Clone kernel source into kernel/ folder
        run: git clone --depth=1 https://github.com/usama19931993/exynos990-kernel1.git kernel

      - name: Merge KernelSU into source
        run: |
          cd kernel
          git clone --depth=1 https://github.com/tiann/KernelSU.git
          mv KernelSU/kernel drivers/kernelsu
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo 'obj-y += kernelsu/' >> drivers/Makefile

      - name: Prepare defconfig
        run: |
          cd kernel
          make O=out ARCH=arm64 g988_defconfig

      - name: Build kernel
        run: |
          cd kernel
          make -j$(nproc) O=out ARCH=arm64

      - name: Build boot.img
        run: |
          cd kernel
          ./mkbootimg.sh

      - name: Create boot.tar.md5 for Odin
        run: |
          cd kernel
          tar -H ustar -c boot.img > boot.tar
          md5sum -t boot.tar >> boot.tar
          mv boot.tar boot.tar.md5

      - name: Upload boot.tar.md5
        uses: actions/upload-artifact@v4
        with:
          name: boot.tar.md5
          path: kernel/boot.tar.md5
