name: Build Exynos990 Kernel with KernelSU and Odin Package

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Checkout kernel source
      uses: actions/checkout@v4

    - name: 🧰 Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip curl wget bc bison flex build-essential \
          libssl-dev libncurses-dev clang python3 python3-pip \
          gcc libc6-dev lib32z1-dev lib32stdc++6

    - name: 📥 Download boot-original.zip from GitHub Releases
      run: |
        mkdir -p boot-original
        wget --header="Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -O boot-original/boot.zip \
          https://github.com/usama19931993/exynos990-kernel1/releases/download/boot/boot-original.zip
        unzip -o boot-original/boot.zip -d boot-original
        cp boot-original/boot.img kernel/

    - name: 🔁 Clone KernelSU
      run: |
        git clone --depth=1 https://github.com/KernelSU/KernelSU kernel/kernelSU

    - name: ⚙️ Apply KernelSU patch
      working-directory: kernel
      run: |
        ./kernelSU/scripts/setup.sh

    - name: 🛠️ Build the kernel
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export PATH=/usr/lib/ccache:/usr/bin:$PATH

        make -C kernel O=out exynos990-kernel_defconfig
        make -C kernel O=out -j$(nproc)

    - name: 📦 Pack new boot.img
      run: |
        mkdir final-boot
        curl -Lo magiskboot https://github.com/topjohnwu/magiskboot/releases/latest/download/magiskboot-linux-x86_64
        chmod +x magiskboot
        ./magiskboot unpack kernel/out/arch/arm64/boot/Image boot-original/boot.img
        ./magiskboot repack boot-original/boot.img
        mv new-boot.img final-boot/boot.img

    - name: 🧳 Create Odin flashable boot.tar.md5
      run: |
        cd final-boot
        tar -H ustar -c boot.img > boot.tar
        md5sum -t boot.tar | awk '{print $1}' >> boot.tar
        mv boot.tar boot.tar.md5

    - name: 📤 Upload boot.tar.md5
      uses: actions/upload-artifact@v4
      with:
        name: boot.tar.md5
        path: final-boot/boot.tar.md5