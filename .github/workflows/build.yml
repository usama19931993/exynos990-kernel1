
name: Build Exynos990 Kernel (SM-G988B)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KSU_BRANCH: main

    steps:
    - name: üì• Checkout Kernel Source
      uses: actions/checkout@v4

    - name: üß∞ Install Dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y git zip unzip curl wget bc bison flex build-essential \
          libssl-dev libncurses5-dev libncursesw5-dev clang python3 python3-pip \
          gcc libc6-dev lib32z1-dev lib32stdc++6

    - name: üîª Download Original Boot Image
      run: |
        mkdir -p boot-original
        wget --header="Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -O boot-original/boot.zip \
          https://github.com/usama19931993/exynos990-kernel1/releases/download/v1/boot-original.zip
        unzip -o boot-original/boot.zip -d boot-original
        cp boot-original/boot.img kernel/

    - name: üîÅ Clone KernelSU
      run: |
        git clone --depth=1 https://github.com/KernelSU/KernelSU kernel/kernelSU

    - name: ‚öôÔ∏è Prepare Kernel Config
      run: |
        cd kernel
        make ARCH=arm64 exynos990_defconfig
        scripts/config --file .config --enable CONFIG_KPROBES
        scripts/config --file .config --enable CONFIG_MODULES
        scripts/config --file .config --enable CONFIG_KALLSYMS_ALL
        make ARCH=arm64 olddefconfig

    - name: üõ†Ô∏è Build Kernel
      run: |
        cd kernel
        make -j$(nproc) ARCH=arm64

    - name: üß© Merge Kernel with boot.img (anykernel or mkbootimg)
      run: |
        echo "Merging zImage with boot.img..."
        # Place merging logic here based on your setup (e.g., mkbootimg or anykernel3)

    - name: üì¶ Package to boot.tar.md5 for Odin
      run: |
        cd output
        tar -H ustar -c boot.img > boot.tar
        md5sum -t boot.tar >> boot.tar
        mv boot.tar boot.tar.md5

    - name: ‚¨ÜÔ∏è Upload boot.tar.md5 to Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: boot-for-odin
        path: output/boot.tar.md5